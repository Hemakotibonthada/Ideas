datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Organization {
  id             String   @id @default(cuid())
  name           String
  industry       String?
  plan           Plan     @default(STARTER)
  stripeCustomerId String? @unique
  apiKeys        ApiKey[]
  scans          Scan[]
  webhooks       Webhook[]
  users          User[]
  monthlyQuota   Int      @default(1000)
  usedQuota      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  passwordHash   String
  role           Role     @default(MEMBER)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ApiKey {
  id             String   @id @default(cuid())
  key            String   @unique
  name           String
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean  @default(true)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  scans          Scan[]
  rateLimit      Int      @default(100)
  createdAt      DateTime @default(now())
}

model Scan {
  id              String     @id @default(cuid())
  mediaType       MediaType
  sourceUrl       String?
  fileName        String?
  fileSizeBytes   Int?
  status          ScanStatus @default(PENDING)
  verdict         Verdict?
  confidenceScore Float?
  processingTimeMs Int?
  modelVersion    String?
  detectionDetails Json?
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  apiKeyId        String?
  apiKey          ApiKey?    @relation(fields: [apiKeyId], references: [id])
  alerts          Alert[]
  createdAt       DateTime   @default(now())
  completedAt     DateTime?

  @@index([organizationId, createdAt])
  @@index([verdict])
}

model Alert {
  id          String      @id @default(cuid())
  scanId      String
  scan        Scan        @relation(fields: [scanId], references: [id])
  severity    Severity
  message     String
  acknowledged Boolean    @default(false)
  createdAt   DateTime    @default(now())
}

model Webhook {
  id             String   @id @default(cuid())
  url            String
  secret         String
  events         String[] // ["scan.completed", "alert.created"]
  isActive       Boolean  @default(true)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  userId    String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
}

enum Plan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum MediaType {
  VIDEO
  AUDIO
  IMAGE
  LIVE_STREAM
}

enum ScanStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Verdict {
  AUTHENTIC
  MANIPULATED
  SUSPICIOUS
  INCONCLUSIVE
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
