datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ─── Enums ───────────────────────────────────────────────

enum PostureIssue {
  FORWARD_HEAD
  ROUNDED_SHOULDERS
  SLOUCHING
  CROSSED_LEGS
  SCREEN_TOO_LOW
  LEANING
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TargetArea {
  NECK
  UPPER_BACK
  LOWER_BACK
  SHOULDERS
  HIPS
  CORE
  FULL_BODY
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  ABANDONED
}

// ─── Models ──────────────────────────────────────────────

model User {
  id             String           @id @default(cuid())
  email          String           @unique
  name           String
  avatarUrl      String?
  height         Float?           // cm
  weight         Float?           // kg
  occupation     String?
  workHoursStart String?          // "09:00"
  workHoursEnd   String?          // "17:00"
  timezone       String           @default("UTC")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  sessions       PostureSession[]
  exerciseLogs   ExerciseLog[]
  goals          GoalSetting[]

  @@index([email])
}

model PostureSession {
  id        String         @id @default(cuid())
  userId    String
  startTime DateTime
  endTime   DateTime?
  duration  Int?           // minutes
  avgScore  Float          // 0-100
  minScore  Float?
  maxScore  Float?
  alerts    Int            @default(0) // total alerts triggered
  breaks    Int            @default(0)
  createdAt DateTime       @default(now())

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  events PostureEvent[]

  @@index([userId])
  @@index([startTime(sort: Desc)])
  @@index([userId, startTime(sort: Desc)])
  @@index([avgScore])
}

model PostureEvent {
  id         String       @id @default(cuid())
  sessionId  String
  timestamp  DateTime
  issue      PostureIssue
  severity   Severity
  screenshot String?
  angle      Float?       // degrees of deviation
  duration   Int?         // seconds the issue persisted
  dismissed  Boolean      @default(false)
  corrected  Boolean      @default(false)
  createdAt  DateTime     @default(now())

  session PostureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([issue])
  @@index([severity])
  @@index([timestamp])
  @@index([sessionId, issue])
}

model Exercise {
  id           String       @id @default(cuid())
  name         String
  targetArea   TargetArea
  duration     Int          // seconds
  instructions String
  videoUrl     String?
  imageUrl     String?
  difficulty   Int          @default(1) // 1-5
  reps         Int?
  sets         Int?
  equipment    String?
  benefits     String[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  logs         ExerciseLog[]

  @@index([targetArea])
  @@index([difficulty])
  @@index([name])
  @@index([targetArea, difficulty])
}

model ExerciseLog {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String
  date       DateTime
  completed  Boolean  @default(false)
  duration   Int?     // actual seconds spent
  painLevel  Int?     // 0-10
  notes      String?
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([exerciseId])
  @@index([date(sort: Desc)])
  @@index([userId, date(sort: Desc)])
  @@index([completed])
}

model GoalSetting {
  id            String     @id @default(cuid())
  userId        String
  title         String
  description   String?
  targetScore   Float      // target avg posture score
  currentScore  Float      @default(0)
  dailyMinutes  Int?       // target monitoring minutes per day
  exerciseGoal  Int?       // exercises per week
  status        GoalStatus @default(ACTIVE)
  startDate     DateTime   @default(now())
  endDate       DateTime?
  completedAt   DateTime?
  streakDays    Int        @default(0)
  bestStreak    Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([userId, status])
}
