datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ── Enums ──────────────────────────────────────────────

enum GroupType {
  ROOMMATES
  TRIP
  COUPLE
  FRIENDS
  FAMILY
  WORK
}

enum SplitType {
  EQUAL
  PERCENTAGE
  EXACT
  SHARES
}

enum PaymentMethod {
  CASH
  VENMO
  ZELLE
  PAYPAL
  BANK_TRANSFER
}

enum Frequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

// ── Models ─────────────────────────────────────────────

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  name            String
  avatarUrl       String?
  defaultCurrency String         @default("USD")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  createdGroups   Group[]        @relation("GroupCreator")
  memberships     GroupMember[]
  paidExpenses    Expense[]      @relation("ExpensePayer")
  expenseSplits   ExpenseSplit[]
  sentSettlements     Settlement[]   @relation("SettlementFrom")
  receivedSettlements Settlement[]   @relation("SettlementTo")
  recurringBills  RecurringBill[] @relation("RecurringPayer")
}

model Group {
  id          String        @id @default(cuid())
  name        String
  type        GroupType     @default(FRIENDS)
  createdById String
  createdBy   User          @relation("GroupCreator", fields: [createdById], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     GroupMember[]
  expenses    Expense[]
  settlements Settlement[]
  recurringBills RecurringBill[]
}

model GroupMember {
  id       String     @id @default(cuid())
  groupId  String
  group    Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId   String
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())

  @@unique([groupId, userId])
}

model Expense {
  id        String        @id @default(cuid())
  groupId   String
  group     Group         @relation(fields: [groupId], references: [id], onDelete: Cascade)
  paidById  String
  paidBy    User          @relation("ExpensePayer", fields: [paidById], references: [id])
  title     String
  amount    Float
  currency  String        @default("USD")
  category  String?
  date      DateTime      @default(now())
  splitType SplitType     @default(EQUAL)
  receipt   String?       // URL to receipt image
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  splits    ExpenseSplit[]

  @@index([groupId, date])
}

model ExpenseSplit {
  id         String  @id @default(cuid())
  expenseId  String
  expense    Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  userId     String
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  owedAmount Float
  paidAmount Float   @default(0)
  settled    Boolean @default(false)

  @@unique([expenseId, userId])
  @@index([userId, settled])
}

model Settlement {
  id         String        @id @default(cuid())
  fromUserId String
  fromUser   User          @relation("SettlementFrom", fields: [fromUserId], references: [id])
  toUserId   String
  toUser     User          @relation("SettlementTo", fields: [toUserId], references: [id])
  groupId    String
  group      Group         @relation(fields: [groupId], references: [id], onDelete: Cascade)
  amount     Float
  method     PaymentMethod
  settledAt  DateTime      @default(now())
  note       String?
  createdAt  DateTime      @default(now())

  @@index([groupId, settledAt])
}

model RecurringBill {
  id          String    @id @default(cuid())
  groupId     String
  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  title       String
  amount      Float
  frequency   Frequency @default(MONTHLY)
  nextDueDate DateTime
  paidById    String
  paidBy      User      @relation("RecurringPayer", fields: [paidById], references: [id])
  splitType   SplitType @default(EQUAL)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([groupId, nextDueDate])
}
