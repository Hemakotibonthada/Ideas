datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ─── Enums ───────────────────────────────────────────────

enum ItemCategory {
  TOOLS
  KITCHEN
  SPORTS
  ELECTRONICS
  GARDEN
  BABY
  BOOKS
  OTHER
}

enum BorrowStatus {
  PENDING
  APPROVED
  ACTIVE
  RETURNED
  DECLINED
  CANCELLED
}

enum EventType {
  CLEANUP
  MEETUP
  GARAGE_SALE
  BLOCK_PARTY
  WORKSHOP
  EMERGENCY
}

enum EmergencyType {
  LOST_PET
  POWER_OUTAGE
  WEATHER
  SAFETY
  MISSING_PERSON
  FLOOD
}

enum RSVPStatus {
  GOING
  MAYBE
  NOT_GOING
}

enum ReviewContext {
  BORROW
  SKILL
  EVENT
}

// ─── Models ──────────────────────────────────────────────

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  address    String?
  lat        Float?
  lng        Float?
  avatarUrl  String?
  trustScore Float    @default(0)
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  items           Item[]
  borrowRequests  BorrowRequest[]
  skillOffers     SkillOffer[]
  organizedEvents Event[]
  eventRsvps      EventRSVP[]
  emergencyPosts  EmergencyPost[]
  reviewsGiven    Review[]          @relation("ReviewerRelation")
  reviewsReceived Review[]          @relation("ReviewedRelation")
}

model Item {
  id          String       @id @default(cuid())
  ownerId     String
  title       String
  description String?
  category    ItemCategory
  photoUrl    String?
  condition   String?
  available   Boolean      @default(true)
  borrowFee   Float?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  owner          User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  borrowRequests BorrowRequest[]

  @@index([ownerId])
  @@index([category])
  @@index([available])
}

model BorrowRequest {
  id         String       @id @default(cuid())
  itemId     String
  borrowerId String
  startDate  DateTime
  endDate    DateTime
  status     BorrowStatus @default(PENDING)
  message    String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  item     Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  borrower User @relation(fields: [borrowerId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([borrowerId])
  @@index([status])
}

model SkillOffer {
  id           String   @id @default(cuid())
  userId       String
  skill        String
  description  String?
  hourlyRate   Float?
  availability Json?
  rating       Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Event {
  id            String    @id @default(cuid())
  organizerId   String
  title         String
  description   String?
  type          EventType
  location      String?
  date          DateTime
  maxAttendees  Int?
  attendeesCount Int      @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  organizer User        @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  rsvps     EventRSVP[]

  @@index([organizerId])
  @@index([date])
  @@index([type])
}

model EventRSVP {
  id      String     @id @default(cuid())
  eventId String
  userId  String
  status  RSVPStatus @default(GOING)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

model EmergencyPost {
  id             String        @id @default(cuid())
  userId         String
  type           EmergencyType
  title          String
  description    String?
  lat            Float?
  lng            Float?
  radius         Float?
  active         Boolean       @default(true)
  responsesCount Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([active])
  @@index([type])
}

model Review {
  id         String        @id @default(cuid())
  reviewerId String
  reviewedId String
  rating     Int
  comment    String?
  context    ReviewContext
  createdAt  DateTime      @default(now())

  reviewer User @relation("ReviewerRelation", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewed User @relation("ReviewedRelation", fields: [reviewedId], references: [id], onDelete: Cascade)

  @@index([reviewerId])
  @@index([reviewedId])
  @@index([context])
}
